"use strict";(()=>{var e={};e.id=925,e.ids=[925],e.modules={11185:e=>{e.exports=require("mongoose")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},52226:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>k,originalPathname:()=>N,patchFetch:()=>P,requestAsyncStorage:()=>I,routeModule:()=>S,serverHooks:()=>R,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>O});var o={};t.r(o),t.d(o,{POST:()=>w});var a=t(67492),n=t(68179),i=t(63075),s=t(88775);t(68775);var c=t(88437),d=t(63647),l=t(11185);let u=new l.Schema({createdAt:{type:Date,default:Date.now},orderId:{type:String,required:!0,unique:!0},checkoutId:{type:String,required:!0},customerId:{type:String},productId:{type:String,required:!0},amount:{type:Number,required:!0},credits:{type:Number},plan:{type:String},buyer:{type:l.Schema.Types.ObjectId,ref:"User"}}),p=l.models?.Transaction||(0,l.model)("Transaction",u);var m=t(43767);async function f(e){try{if("FREE"===e.plan.toUpperCase())return{success:!0};if(!e.productId)throw Error(`Invalid product ID for plan: ${e.plan}`);let r=process.env.CREEM_API_LOCATION||"https://api.creem.io/v1/checkouts",t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":process.env.CREEM_API_KEY},body:JSON.stringify({product_id:e.productId,request_id:`${e.buyerId}-${Date.now()}`,success_url:"https://removeshadow.com/profile",metadata:{plan:e.plan,credits:e.credits,buyerId:e.buyerId}})});if(!t.ok){let e=await t.json();throw Error(`Checkout session creation failed: ${JSON.stringify(e)}`)}return{checkoutUrl:(await t.json()).checkout_url}}catch(e){throw console.error("Checkout error:",e),e}}async function g(e){try{if(await (0,d.v)(),console.log("Creating transaction:",e),!e.buyerId||!e.credits)throw Error(`Missing required fields: ${JSON.stringify(e)}`);let r=await p.create({...e,buyer:e.buyerId});console.log("Transaction created:",r);let t=await (0,m.updateCredits)(e.buyerId,e.credits);return console.log("User credits updated:",t),t||console.error("Failed to update user credits, but transaction was created"),JSON.parse(JSON.stringify(r))}catch(e){throw console.error("Transaction creation error:",e),(0,c.S3)(e),e}}(0,t(69303).h)([f,g]),(0,s.U)("ac25ba21424da4d6580d40083e71989f70585f2f",f),(0,s.U)("4675dccc637565c78403f7ee3d90122afb8ab35a",g);var h=t(51945),b=t(6113),v=t.n(b);let y=(e,r,t)=>v().createHmac("sha256",t).update(e).digest("hex")===r;async function w(e){let r=await e.text(),t=e.headers.get("creem-signature");if(!t)return h.Z.json({message:"No signature"},{status:401});try{console.log("Webhook received with signature:",t),y(r,t,process.env.CREEM_API_KEY)||(console.error("Signature validation failed"),console.warn("Proceeding despite signature validation failure"));let e=JSON.parse(r);if(console.log("Received webhook event:",e),"checkout.completed"===e.eventType){let{id:r,order:{id:t},customer:{id:o},product:{id:a},metadata:n,order:i}=e.object;if(console.log("Extracted transaction data:",{checkout_id:r,order_id:t,customer_id:o,product_id:a,metadata:n,order:i}),!n?.plan||!n?.credits||!n?.buyerId)throw console.error("Missing metadata:",n),Error("Missing required metadata");if(!i?.amount)throw console.error("Missing order amount:",i),Error("Missing order amount");let s={orderId:t,checkoutId:r,customerId:o,productId:a,amount:i.amount/100,plan:n.plan,credits:Number(n.credits),buyerId:n.buyerId,createdAt:new Date};console.log("Creating transaction with data:",s);try{let e=await g(s);return console.log("Transaction created successfully:",e),h.Z.json({message:"OK",transaction:e})}catch(e){throw console.error("Failed to create transaction:",e),e}}return new Response("",{status:200})}catch(e){return console.error("Webhook error:",e),h.Z.json({message:"Webhook error",error:e},{status:500})}}let S=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/webhooks/creem/route",pathname:"/api/webhooks/creem",filename:"route",bundlePath:"app/api/webhooks/creem/route"},resolvedPagePath:"D:\\visual studio code\\project\\learn React and Nextjs\\imaginify\\app\\api\\webhooks\\creem\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:I,staticGenerationAsyncStorage:E,serverHooks:R,headerHooks:k,staticGenerationBailout:O}=S,N="/api/webhooks/creem/route";function P(){return(0,i.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:E})}},3222:(e,r,t)=>{t.d(r,{FV:()=>o,V3:()=>i,Zq:()=>a,vB:()=>n});let o=[{label:"Home",route:"/",icon:"/assets/icons/home.svg"},{label:"Shadow Remove",route:"/transformations/add/remove-shadow-from-photo",icon:"/assets/icons/scan.svg"},{label:"Background Remove",route:"/transformations/add/remove-background-from-image",icon:"/assets/icons/camera.svg"},{label:"Object Remove",route:"/transformations/add/remove-object-from-photo",icon:"/assets/icons/scan.svg"},{label:"Generative Fill",route:"/transformations/add/generative-fill",icon:"/assets/icons/stars.svg"},{label:"Object Recolor",route:"/transformations/add/image-recolor",icon:"/assets/icons/filter.svg"},{label:"Image Restore",route:"/transformations/add/image-restore",icon:"/assets/icons/image.svg"},{label:"Profile",route:"/profile",icon:"/assets/icons/profile.svg"},{label:"Pricing",route:"/pricing",icon:"/assets/icons/bag.svg"}],a={STARTER:"prod_4QSoqhZCOwWEqUdTPvNVYp",BASIC:"prod_6UpCTzor7KTqIi7GpZT3hT",PRO:"prod_WDBXZBCJqa7RkIFSWRofp",BUSINESS:"prod_5jYVdEdomzvNIC84A1cKJp",ENTERPRISE:"prod_58zpq328Rk4LywImlGEdgA"};a.STARTER,a.BASIC,a.PRO,a.BUSINESS,a.ENTERPRISE;let n={"remove-shadow-from-photo":{type:"remove-shadow-from-photo",title:"Remove Shadow From Photo",subTitle:"Remove shadow from photo using AI",config:{remove:{prompt:"unwanted background shadows",removeShadow:!0,multiple:!0}},icon:"scan.svg"},"image-restore":{type:"image-restore",title:"Restore Image",subTitle:"Refine images by removing noise and imperfections",config:{restore:!0},icon:"image.svg"},"remove-background-from-image":{type:"remove-background-from-image",title:"Remove Background From Image",subTitle:"Removes the background of the image using AI",config:{removeBackground:!0},icon:"camera.svg"},"generative-fill":{type:"generative-fill",title:"Generative Fill",subTitle:"Enhance an image's dimensions using AI outpainting",config:{fillBackground:!0},icon:"stars.svg"},"remove-object-from-photo":{type:"remove-object-from-photo",title:"Remove Object From Photo",subTitle:"Identify and eliminate objects from images",config:{remove:{prompt:"",removeShadow:!0,multiple:!0}},icon:"scan.svg"},"image-recolor":{type:"image-recolor",title:"Image Recolor",subTitle:"Identify and recolor objects from the image",config:{recolor:{prompt:"",to:"",multiple:!0}},icon:"filter.svg"}},i={"1:1":{aspectRatio:"1:1",label:"Square (1:1)",width:1e3,height:1e3},"3:4":{aspectRatio:"3:4",label:"Standard Portrait (3:4)",width:1e3,height:1334},"9:16":{aspectRatio:"9:16",label:"Phone Portrait (9:16)",width:1e3,height:1778}}},43767:(e,r,t)=>{t.r(r),t.d(r,{createUser:()=>c,deleteUser:()=>u,getUserById:()=>d,updateCredits:()=>p,updateUser:()=>l});var o=t(88775);t(68775);var a=t(50060),n=t(21403),i=t(63647),s=t(88437);async function c(e){try{await (0,i.v)();let r=await n.Z.create(e);return JSON.parse(JSON.stringify(r))}catch(e){(0,s.S3)(e)}}async function d(e){try{await (0,i.v)();let r=await n.Z.findOne({clerkId:e});if(!r)throw Error("User not found");return JSON.parse(JSON.stringify(r))}catch(e){(0,s.S3)(e)}}async function l(e,r){try{await (0,i.v)();let t=await n.Z.findOneAndUpdate({clerkId:e},r,{new:!0});if(!t)throw Error("User update failed");return JSON.parse(JSON.stringify(t))}catch(e){(0,s.S3)(e)}}async function u(e){try{await (0,i.v)();let r=await n.Z.findOne({clerkId:e});if(!r)throw Error("User not found");let t=await n.Z.findByIdAndDelete(r._id);return(0,a.revalidatePath)("/"),t?JSON.parse(JSON.stringify(t)):null}catch(e){(0,s.S3)(e)}}async function p(e,r){try{await (0,i.v)();let t=await n.Z.findById(e);if(!t)throw Error("User not found");console.log("Current credits:",t.creditBalance),console.log("Adding credits:",r);let o=await n.Z.findByIdAndUpdate(e,{$inc:{creditBalance:r}},{new:!0});return console.log("Updated credits:",o.creditBalance),o}catch(e){throw console.error("Error updating credits:",e),(0,s.S3)(e),e}}(0,t(69303).h)([c,d,l,u,p]),(0,o.U)("142443fc102798e02caf7749c72c67d88cc0d1f9",c),(0,o.U)("9eeec8055808c1780baee03e37e448f0d44736f1",d),(0,o.U)("917bd2a2bbafa2bbf2cb903406452986486715b2",l),(0,o.U)("1bd2439848cce1253a71f69a051c88b31fb54b8f",u),(0,o.U)("865460400823edc85e8779e5b6640367cd36aa48",p)},21403:(e,r,t)=>{t.d(r,{Z:()=>n});var o=t(11185);let a=new o.Schema({clerkId:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},username:{type:String,required:!0,unique:!0},photo:{type:String,required:!0},firstName:{type:String},lastName:{type:String},planId:{type:Number,default:1},creditBalance:{type:Number,default:5}}),n=o.models?.User||(0,o.model)("User",a)},63647:(e,r,t)=>{t.d(r,{v:()=>s});var o=t(11185),a=t.n(o);let n=process.env.MONGODB_URL,i=global.mongoose;i||(i=global.mongoose={conn:null,promise:null});let s=async()=>{if(i.conn)return i.conn;if(!n)throw Error("Missing MONGODB_URL");return i.promise=i.promise||a().connect(n,{dbName:"cluster0",bufferCommands:!1}),i.conn=await i.promise,i.conn}},88437:(e,r,t)=>{t.d(r,{Ad:()=>c,S3:()=>s,cn:()=>i});var o=t(48232),a=t(78787),n=t(3222);function i(...e){return(0,a.m6)((0,o.W)(e))}let s=e=>{if(e instanceof Error)throw console.error(e.message),Error(`Error: ${e.message}`);if("string"==typeof e)throw console.error(e),Error(`Error: ${e}`);throw console.error(e),Error(`Unknown error: ${JSON.stringify(e)}`)},c=(e,r,t)=>"fill"===e?n.V3[r.aspectRatio]?.[t]||1e3:r?.[t]||1e3},4500:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),function(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}(r,{INTERCEPTION_ROUTE_MARKERS:function(){return a},isInterceptionRouteAppPath:function(){return n},extractInterceptionRouteInformation:function(){return i}});let o=t(27714),a=["(..)(..)","(.)","(..)","(...)"];function n(e){return void 0!==e.split("/").find(e=>a.find(r=>e.startsWith(r)))}function i(e){let r,t,n;for(let o of e.split("/"))if(t=a.find(e=>o.startsWith(e))){[r,n]=e.split(t,2);break}if(!r||!t||!n)throw Error(`Invalid interception route: ${e}. Must be in the format /<intercepting route>/(..|...|..)(..)/<intercepted route>`);switch(r=(0,o.normalizeAppPath)(r),t){case"(.)":n="/"===r?`/${n}`:r+"/"+n;break;case"(..)":if("/"===r)throw Error(`Invalid interception route: ${e}. Cannot use (..) marker at the root level, use (.) instead.`);n=r.split("/").slice(0,-1).concat(n).join("/");break;case"(...)":n="/"+n;break;case"(..)(..)":let i=r.split("/");if(i.length<=2)throw Error(`Invalid interception route: ${e}. Cannot use (..)(..) marker at the root level or one level up.`);n=i.slice(0,-2).concat(n).join("/");break;default:throw Error("Invariant: unexpected marker")}return{interceptingRoute:r,interceptedRoute:n}}},67492:(e,r,t)=>{e.exports=t(30517)},61521:(e,r)=>{function t(e){return e.startsWith("/")?e:"/"+e}Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"ensureLeadingSlash",{enumerable:!0,get:function(){return t}})},27714:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),function(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}(r,{normalizeAppPath:function(){return n},normalizeRscURL:function(){return i}});let o=t(61521),a=t(80940);function n(e){return(0,o.ensureLeadingSlash)(e.split("/").reduce((e,r,t,o)=>!r||(0,a.isGroupSegment)(r)||"@"===r[0]||("page"===r||"route"===r)&&t===o.length-1?e:e+"/"+r,""))}function i(e){return e.replace(/\.rsc($|\?)/,"$1")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[867,263,60],()=>t(52226));module.exports=o})();